<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FinQuest</title>
  <style>
    :root{
      --lilac:#B7C3E8; --solid:#8EA207; --sailing:#4569AD; --dive:#1F3F74; --deepsea:#14366D; --night:#081F44;
      --card-bg: rgba(255,255,255,0.03);
      --glass: rgba(255,255,255,0.02);
    }
    *{box-sizing:border-box; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    body{margin:0; background: linear-gradient(180deg, #E6EAFC 0%, #B7C3E8 45%, #EEF4FF 100%); color:var(--night)}
    .wrap{max-width:1150px; margin:18px auto; padding:18px}
    header{display:flex;align-items:center;gap:16px}
    .logo{width:60px;height:60px;border-radius:12px;background:linear-gradient(135deg,var(--sailing),var(--dive));display:flex;align-items:center;justify-content:center;font-weight:800;color:white}
    h1{margin:0;font-size:20px}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:18px;margin-top:14px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.92)); padding:14px;border-radius:12px;box-shadow:0 6px 22px rgba(20,54,109,0.08)}
    .small{font-size:13px;color:#14366D}
    .wallet{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .big-balance{font-size:28px;font-weight:800;color:var(--dive)}
    .btn{background:var(--sailing);color:white;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn.secondary{background:linear-gradient(90deg,var(--solid),#7fbf3a);color:white;border:none}
    .hidden{display:none}
    .row{display:flex;gap:12px;align-items:center}
    .badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{background:linear-gradient(90deg,#fff,#f8ffef);padding:6px 8px;border-radius:8px;font-weight:700;color:var(--deepsea)}
    #chart{width:100%;height:140px;border-radius:8px;background:linear-gradient(180deg,#f7f9ff,#eef6ff);padding:8px}
    .chat{max-height:220px;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px;background:linear-gradient(180deg,#ffffff,#f7fbff);border-radius:8px}
    .msg{padding:8px;border-radius:8px;max-width:80%}
    .msg.user{background:linear-gradient(90deg,#f0f7ff,#e6f1ff);align-self:flex-end}
    .msg.ai{background:linear-gradient(90deg,#fff6f6,#eef7ff);border-left:4px solid var(--sailing)}
    .level-box{padding:12px;border-radius:12px;background:linear-gradient(180deg,#ffffff,#f2f8ff);border:1px solid rgba(20,54,109,0.04);margin-bottom:10px}
    .choice{display:block;padding:10px;border-radius:10px;background:#f6fbff;border:1px solid rgba(20,54,109,0.05);margin-top:8px;color:var(--dive);cursor:pointer}
    .choice:hover{transform:translateY(-3px);transition:transform .12s}
    .modal-backdrop{position:fixed;inset:0;background:rgba(4,10,20,0.45);display:flex;align-items:center;justify-content:center;z-index:3000;opacity:0;pointer-events:none;transition:opacity .18s ease}
    .modal-backdrop.show{opacity:1;pointer-events:auto}
    .modal{background:white;padding:16px;border-radius:12px;max-width:520px;width:92%;box-shadow:0 14px 40px rgba(8,31,68,.18);text-align:center;border:1px solid rgba(20,54,109,.04)}
    .glossary-box{margin-top:12px;background:linear-gradient(180deg,#f9fbff,#ffffff);padding:12px;border-radius:8px;border:1px solid rgba(20,54,109,0.03)}
    .term{margin-bottom:8px}
    .term strong{color:var(--dive)}
    .coin-pop{position:fixed;right:18px;top:90px;z-index:4000;pointer-events:none}
    .coin-float{background:linear-gradient(90deg,var(--sailing),var(--dive));color:white;padding:6px 10px;border-radius:999px;font-weight:800;box-shadow:0 8px 30px rgba(8,31,68,.25);transform:translateY(0);opacity:1;transition:transform 1s,opacity 1s}
    .coin-float.minus{background:linear-gradient(90deg,#ff6b6b,#ff9a9a)}
    /* improved profile boxes behind text */
    .profile-glass{background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.8)); padding:12px; border-radius:12px; box-shadow: 0 8px 30px rgba(20,54,109,0.06); border:1px solid rgba(20,54,109,0.03)}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">FQ</div>
      <div>
        <h1>FinQuest — The Game of cents and sense</h1>
        <div class="small">Levels, quizzes, investing</div>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <div>
        <div class="card">
          <!-- Profile create -->
          <div id="profileCreateArea">
            <div class="profile-glass">
              <h3 style="margin:0">Create Profile</h3>
              <div class="small" style="margin-top:6px">Add name, grade and interest. Or load demo for quick demo.</div>
              <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px">
                <input id="nameInput" placeholder="Your name" />
                <select id="gradeSelect">
                  <option value="6">Grade 6</option><option value="7">Grade 7</option><option value="8">Grade 8</option>
                  <option value="9">Grade 9</option><option value="10">Grade 10</option><option value="11">Grade 11</option><option value="12">Grade 12</option>
                </select>
                <input id="interestInput" placeholder="Interest (tech, art...)" />
                <div class="row">
                  <button class="btn" id="createProfileBtn">Create & Start Level 1</button>
                  <button class="btn secondary" id="demoBtn">Demo</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Profile view -->
          <div id="profileView" class="hidden" style="margin-top:12px; position:relative;">
            <!-- logout top-right -->
            <button id="logoutBtn" class="btn secondary" style="position:absolute; right:12px; top:12px">Logout</button>

            <div class="profile-glass">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <div class="small">Player</div>
                  <div style="font-weight:800" id="playerName">—</div>
                  <div id="playerGrade" class="small">Grade —</div>
                </div>
                <div style="text-align:right">
                  <div class="small">Rank</div>
                  <div style="font-weight:800" id="playerRank">Rookie</div>
                  <div class="small">Badges: <span id="badgeCount">0</span></div>
                </div>
              </div>

              <hr style="margin:12px 0;border:none;border-top:1px solid rgba(20,54,109,0.04)" />

              <div class="wallet">
                <div>
                  <div class="small">FinCoin Wallet</div>
                  <div class="big-balance" id="finBalance">₹0</div>
                  <div class="small">Allowance: <span id="allowanceVal">₹0</span></div>
                </div>
                <div>
                  <div class="small">Happiness</div>
                  <div style="font-weight:700" id="happinessVal">0</div>
                  <div class="small" style="margin-top:6px">Knowledge: <span id="knowledgeVal">0</span></div>
                </div>
              </div>

              <div style="margin-top:12px" class="small">Quick actions</div>
              <div class="row" style="margin-top:8px">
                <button class="btn" id="startLevel1Btn">Start Level 1</button>
                <button class="btn secondary" id="openLevelsBtn">Levels Hub</button>
                <button class="btn secondary" id="openJournalBtn">Journal</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4 style="margin:0 0 8px">Levels Hub</h4>
          <div id="levelsHub"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h4 style="margin:0 0 8px">Badges</h4>
          <div class="badges" id="badgesWrap"></div>
        </div>

      </div>

      <!-- RIGHT -->
      <div>
        <div class="card">
          <h3 id="playHeader">Welcome to FinQuest</h3>

          <div id="introArea">
            <div class="small">Create a profile to begin. Demo is available.</div>
            <div style="margin-top:10px">
              <button class="btn" id="quickStartBtn">Quick Start Level 1</button>
            </div>
          </div>

          <div id="gameArea" class="hidden" style="margin-top:12px">
            <div id="levelHeader" style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <h4 id="levelTitle">Level</h4>
                <div id="levelGoal" class="small"></div>
              </div>
              <div style="text-align:right">
                <div class="small">Progress</div>
                <div style="height:10px;background:linear-gradient(90deg,#eef6ff,#f0f6ff);border-radius:999px;overflow:hidden;width:220px"><i id="levelProgressBar" style="display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--sailing),var(--dive))"></i></div>
                <div class="small" id="progressText">0 / 0 stages</div>
              </div>
            </div>

            <div id="stageBox" style="margin-top:12px"></div>
            <div id="interactiveArea" style="margin-top:12px"></div>
            <div style="margin-top:12px" class="row">
              <button class="btn secondary" id="nextStageBtn">Next Stage</button>
              <button class="btn secondary" id="takeSatQuizBtn">Saturday Quiz</button>
              <button class="btn secondary" id="easterBtn">Easter Quiz</button>
            </div>

            <div class="glossary-box" id="glossaryBox" style="display:none">
              <h4 style="margin:6px 0">Glossary — terms learned (definitions in bold)</h4>
              <div id="glossaryList"></div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>AI Coach</h3>
          <div class="chat" id="chatWrap">
            <div class="msg ai">FinMate: Create a profile and begin Level 1. I'll give tips and feedback.</div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="chatInput" placeholder="Ask FinMate..." />
            <button class="btn" id="sendChatBtn">Send</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3>Investment Zone</h3>
            <div class="small">Simulated — no real money</div>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <select id="assetSelect">
              <option value="gold">Gold</option>
              <option value="silver">Silver</option>
              <option value="tech">Tech Company</option>
            </select>
            <input id="investAmount" placeholder="Amount" />
            <button class="btn" id="investBtn">Invest</button>
            <button class="btn secondary" id="simMarketBtn">Simulate Market</button>

          </div>

          <div style="margin-top:12px">
            <canvas id="chart"></canvas>
            <div style="display:flex;justify-content:space-between;margin-top:8px">
              <div class="small">Portfolio Value: <span id="portfolioVal">₹0</span></div>
              <div class="small">P/L: <span id="pnlVal">₹0</span></div>
            </div>
            <div style="margin-top:8px">
              <button class="btn secondary" id="viewPortfolioBtn">View / Sell Holdings</button>
            </div>
            <div id="portfolioList" style="margin-top:8px"></div>
          </div>
        </div>

        <div class="card" style="margin-top:12px" id="journalCard">
          <h3>Journal</h3>
          <div id="journalList" style="max-height:160px;overflow:auto"></div>
        </div>

      </div>
    </div>

    <footer style="margin-top:12px" class="small">Prototype — all data stored in your browser (localStorage). Presentation-ready.</footer>
  </div>

  <!-- Modal for confirmations etc -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog">
      <h3 id="modalTitle">Confirm</h3>
      <div class="desc" id="modalDesc"></div>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
        <button id="modalCancel" class="btn secondary">Cancel</button>
        <button id="modalConfirm" class="btn">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Animated coin popup -->
  <div id="coinPop" class="coin-pop"></div>

<script>
/* Final FinQuest Script — No separate savings, wallet cannot go negative, profits realized on SELL */
/* Storage key */
const STORAGE_KEY = 'finquest_final_no_savings';

/* DOM helpers */
const $ = id => document.getElementById(id);
function now(){ return Date.now(); }
function coinFloat(amount){
  const pop = document.createElement('div'); pop.className='coin-float'; pop.style.marginTop='6px';
  pop.innerText = (amount>0? `+₹${amount}` : `-₹${Math.abs(amount)}`);
  if(amount<0) pop.classList.add('minus');
  $('coinPop').appendChild(pop);
  setTimeout(()=> { pop.style.transform='translateY(-90px)'; pop.style.opacity='0'; }, 60);
  setTimeout(()=> pop.remove(), 1200);
}
function addChat(text, who='ai'){ const el = document.createElement('div'); el.className = 'msg ' + (who === 'user' ? 'user' : 'ai'); el.textContent = text; $('chatWrap').appendChild(el); $('chatWrap').scrollTop = $('chatWrap').scrollHeight; }

/* Default state */
function defaultState(){
  const s = {
    profile: null,
    balance: 5000,
    allowance: 5000,
    happiness: 70,
    knowledge: 0,
    badges: [],
    journal: [],
    portfolio: [],
    market: generateMarket(),
    day:1,
    activeLevelKey: null,
    levelsProgress: {},
    glossary: [],
    sips: [],
    fds: [],
    lastEaster:0,
    rank: 'Rookie'
  };
  // init levels progress
  LEVELS.forEach(l=> s.levelsProgress[l.key] = { stage:0, completed:false, unlocked: l.id===1 });
  return s;
}

/* Levels definition (same four levels) */
const LEVELS = [
  { id:1, key:'budgeting', title:'Money & Budgeting', goal:'Learn how to plan, spend, and save money', stages:3,
    scenarios:[
      { type:'choice', title:"You get ₹5,000 for the week. What's your plan?",
        choices:[
          {id:'b1a',label:'A. Spend ₹4,000 on a new outfit', coins:-4000, happy:6, know:0, rating:-1, note:'Bought outfit', terms:['Budget','Needs vs Wants']},
          {id:'b1b',label:'B. Save ₹3,000, spend ₹2,000', coins:-2000, happy:3, know:1, rating:1, note:'Saved part, spent part', terms:['Budget','Saving']},
          {id:'b1c',label:'C. Save everything for a future goal', coins:0, happy:1, know:2, rating:2, note:'Kept money in wallet for goals', terms:['Saving']}
        ],
        glossary: { 'Budget':'**Budget = a plan for your money**', 'Needs vs Wants':'**Needs are necessary, wants are extra**', 'Saving':'**Saving = keeping money aside (in wallet)**' }
      },
      { type:'choice', title:"Your friends invite you to a ₹1,000 movie + dinner. What do you do?",
        choices:[
          {id:'b2a',label:'A. Go for both (Fun > Savings)', coins:-1000, happy:8, know:0, rating:-1, note:'Went for fun'},
          {id:'b2b',label:'B. Movie only (Balance both)', coins:-400, happy:4, know:1, rating:1, note:'Balanced choice'},
          {id:'b2c',label:'C. Skip — save for your goal', coins:0, happy:1, know:2, rating:2, note:'Skipped and kept funds'}
        ],
        glossary: { 'Spending habits':'**Spending habits = how you use money**' }
      },
      { type:'drag', title:'Sort these items into Needs or Wants',
        items:[
          {id:'d1',text:'Groceries', tag:'Need'},
          {id:'d2',text:'New phone (latest model)', tag:'Want'},
          {id:'d3',text:'School supplies', tag:'Need'},
          {id:'d4',text:'Movie + snacks', tag:'Want'}
        ],
        success: { knowledge:2, coins:200 },
        glossary: {}
      }
    ]
  },

  { id:2, key:'banking', title:'Banking Basics', goal:'Understand how banks and safe money tools work', stages:5,
    scenarios:[
      { type:'choice', title:'You have ₹3,000. Bank offers savings account with 2% monthly interest. What do you do?',
        choices:[
          {id:'bn1a',label:'A. Learn about savings account (no move)', coins:0, happy:1, know:2, note:'Learned about savings (no separate account in this prototype)', terms:['Savings Account','Interest']},
          {id:'bn1b',label:'B. Keep all FinCoins in wallet', coins:0, happy:1, know:0, note:'Kept in wallet'},
          {id:'bn1c',label:'C. Spend ₹1,500, keep rest', coins:-1500, happy:3, know:1, note:'Partial spend'}
        ],
        glossary: { 'Savings Account':'**Savings Account = bank product to keep and earn interest (explained here)**', 'Interest':'**Interest = extra money banks give you for saving**' }
      },
      { type:'choice', title:'The bank offers a 3-month FD. Lock ₹1,000 for higher return (FD is an investment).',
        choices:[
          {id:'bn2a',label:'A. Open FD: lock ₹1,000 (investment)', coins:-1000, openFD:1000, happy:2, know:2, note:'Opened FD (locked)'},
          {id:'bn2b',label:'B. Keep money flexible in wallet', coins:0, happy:1, know:0, note:'Kept flexible'},
          {id:'bn2c',label:'C. Spend part now, keep part', coins:-500, happy:3, know:1, note:'Partial spend'}
        ],
        glossary: { 'FD':'**FD = Fixed Deposit — lock money for higher returns (treated as investment)**' }
      },
      { type:'choice', title:'You received a debit card. Why is it helpful?',
        choices:[
          {id:'bn3a',label:'A. Makes spending easier without cash', know:1, happy:1, note:'Used debit card', terms:['Debit Card']},
          {id:'bn3b',label:'B. It is the same as credit card', know:0, happy:0, note:'Misconception'},
          {id:'bn3c',label:'C. It gives free money', know:0, happy:0, note:'Not true'}
        ],
        glossary: { 'Debit Card':'**Debit Card = spends money directly from your wallet/bank**' }
      },
      { type:'input', title:'Mini-sim: Choose how much to keep for a short-term goal (enter amount)', action:'keepGoal' },
      { type:'choice', title:'Mini-challenge: Choose a safe spending plan for a week with ₹2,000.',
        choices:[
          {id:'bn5a',label:'A. Save ₹1,000, spend ₹1,000', coins:-1000, know:1, happy:2},
          {id:'bn5b',label:'B. Spend ₹1,800 now', coins:-1800, happy:6, know:0},
          {id:'bn5c',label:'C. Keep all', coins:0, know:2, happy:1}
        ]
      }
    ]
  },

  { id:3, key:'sip', title:'Mutual Funds & SIPs', goal:'Learn group investments & regular investing', stages:4,
    scenarios:[
      { type:'choice', title:'Start a weekly SIP of ₹500. Which fund do you choose?',
        choices:[
          {id:'s1a',label:'A. Safe Fund — Low risk', coins:-500, investSIP:'safe', know:2, happy:1, note:'Started SIP (safe)'},
          {id:'s1b',label:'B. Balanced Fund — Medium risk', coins:-500, investSIP:'balanced', know:1, happy:1, note:'Started SIP (balanced)'},
          {id:'s1c',label:'C. Tech Fund — High risk', coins:-500, investSIP:'tech', know:1, happy:2, note:'Started SIP (tech)'}
        ],
        glossary: { 'SIP':'**SIP = invest a fixed amount regularly**', 'Mutual Fund':'**Mutual Fund = many investors pool money**' }
      },
      { type:'choice', title:'After 3 weeks, SIP grew 5% but tech dipped 3%. What do you do?',
        choices:[
          {id:'s2a',label:'A. Continue as planned', action:'sipContinue', know:1, happy:1},
          {id:'s2b',label:'B. Withdraw now for safety', action:'sipWithdraw', know:0, happy:-1},
          {id:'s2c',label:'C. Increase investment', action:'sipIncrease', know:1, happy:2}
        ]
      },
      { type:'choice', title:'Risk meter: Which portfolio is more diversified?',
        choices:[
          {id:'s3a',label:'A. 100% Tech stocks', correct:false, know:0},
          {id:'s3b',label:'B. Mix: Cash, Bonds, Mutual Funds, Stocks', correct:true, know:2},
          {id:'s3c',label:'C. Only FDs', correct:false, know:1}
        ]
      },
      { type:'input', title:'Mini-sim: Allocate ₹1,000 between Safe and Risky (enter 70/30)', action:'allocate' }
    ]
  },

  { id:4, key:'invest', title:'Stocks & Investing', goal:'Build an investment mindset', stages:4,
    scenarios:[
      { type:'choice', title:'Market: Gold stable, Tech booming. What do you do?',
        choices:[
          {id:'i1a',label:'A. Invest all in Tech stocks (high risk)', coins:-1000, invest:{asset:'tech', amt:1000}, rating:-1},
          {id:'i1b',label:'B. Split 50% Gold, 50% Tech', coins:-1000, invest:{asset:'split', amt:1000}, rating:1},
          {id:'i1c',label:'C. Keep all FinCoins in wallet', coins:0, rating:0}
        ],
        glossary: { 'Diversification':'**Diversification = don’t put all money in one place**', 'ROI':'**ROI = return on investment**' }
      },
      { type:'choice', title:'New startup shares available — risky but promising.',
        choices:[
          {id:'i2a',label:'A. Invest small amount to test', coins:-200, invest:{asset:'startup', amt:200}},
          {id:'i2b',label:'B. Avoid', coins:0},
          {id:'i2c',label:'C. Go all-in', coins:-1000, invest:{asset:'startup', amt:1000}, rating:-1}
        ]
      },
      { type:'action', title:'Check portfolio: compute ROI on a sample investment', action:'calcROI' },
      { type:'input', title:'Final challenge: Build a balanced 3-asset portfolio for ₹2000 (Gold:40,Tech:40,FD:20 suggested)', action:'buildPortfolio' }
    ]
  }
];

/* Load or init state */
let state = loadState() || defaultState();

/* Ensure levelsProgress present */
if(!state.levelsProgress || Object.keys(state.levelsProgress).length === 0){
  state.levelsProgress = {};
  LEVELS.forEach(l => state.levelsProgress[l.key] = { stage:0, completed:false, unlocked: l.id===1 });
  saveState();
}

/* DOM refs */
const createProfileBtn = $('createProfileBtn'), demoBtn = $('demoBtn'), nameInput = $('nameInput'), gradeSelect = $('gradeSelect'), interestInput = $('interestInput');
const profileCreateArea = $('profileCreateArea'), profileView = $('profileView'), playerName = $('playerName'), playerGrade = $('playerGrade'), playerRank = $('playerRank');
const finBalance = $('finBalance'), allowanceVal = $('allowanceVal'), happinessVal = $('happinessVal'), knowledgeVal = $('knowledgeVal');
const startLevel1Btn = $('startLevel1Btn'), openLevelsBtn = $('openLevelsBtn'), levelsHub = $('levelsHub'), badgesWrap = $('badgesWrap'), badgeCount = $('badgeCount');
const quickStartBtn = $('quickStartBtn'), gameArea = $('gameArea'), levelTitle = $('levelTitle'), levelGoal = $('levelGoal'), levelProgressBar = $('levelProgressBar'), progressText = $('progressText');
const stageBox = $('stageBox'), interactiveArea = $('interactiveArea'), nextStageBtn = $('nextStageBtn'), glossaryBox = $('glossaryBox'), glossaryList = $('glossaryList'), chatInput = $('chatInput'), sendChatBtn = $('sendChatBtn');
const investBtn = $('investBtn'), assetSelect = $('assetSelect'), investAmount = $('investAmount'), simMarketBtn = $('simMarketBtn'), chart = $('chart'), portfolioVal = $('portfolioVal'), pnlVal = $('pnlVal');
const journalList = $('journalList'), openJournalBtn = $('openJournalBtn'), takeSatQuizBtn = $('takeSatQuizBtn'), easterBtn = $('easterBtn');
const modalBackdrop = $('modalBackdrop'), modalTitle = $('modalTitle'), modalDesc = $('modalDesc'), modalCancel = $('modalCancel'), modalConfirm = $('modalConfirm');
const logoutBtn = $('logoutBtn'), viewPortfolioBtn = $('viewPortfolioBtn'), portfolioList = $('portfolioList');

/* Bind events */
createProfileBtn.addEventListener('click', createProfile);
demoBtn.addEventListener('click', loadDemo);
startLevel1Btn.addEventListener('click', ()=> startLevel(LEVELS[0].key));
quickStartBtn.addEventListener('click', ()=> { if(!state.profile){ alert('Create profile first'); return; } startLevel(LEVELS[0].key); });
openLevelsBtn.addEventListener('click', ()=> levelsHub.scrollIntoView({behavior:'smooth'}));
sendChatBtn.addEventListener('click', ()=> { const t = chatInput.value.trim(); if(!t) return; addChat(t,'user'); chatInput.value=''; handleChat(t); });
investBtn.addEventListener('click', performInvestment);
simMarketBtn.addEventListener('click', ()=> { state.market = generateMarket(); redrawChart(); saveState(); addChat('Market simulated.'); });
openJournalBtn.addEventListener('click', ()=> $('journalCard').scrollIntoView({behavior:'smooth'}));
takeSatQuizBtn.addEventListener('click', takeSaturdayQuiz);
easterBtn.addEventListener('click', showEasterQuiz);
nextStageBtn.addEventListener('click', ()=> { if(!state.activeLevelKey) return; advanceStage(state.activeLevelKey); });
modalCancel.addEventListener('click', closeModal);
modalConfirm.addEventListener('click', ()=> { if(typeof modalConfirm._cb === 'function') modalConfirm._cb(); closeModal(); });

logoutBtn.addEventListener('click', ()=> {
  if(confirm('Are you sure you want to logout? This will clear all progress and require re-creating profile.')) {
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }
});

viewPortfolioBtn.addEventListener('click', ()=> { renderPortfolioList(); portfolioList.scrollIntoView({behavior:'smooth'}); });

/* Initial render */
updateProfileUI();
renderLevelsHub();
redrawChart();
renderJournal();
renderGlossary();

/* ===== Functions ===== */
function saveState(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e){ console.error('save error', e); } }
function loadState(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)); } catch(e){ return null; } }

/* Profile handling */
function createProfile(){
  const name = nameInput.value.trim() || 'Player';
  const grade = parseInt(gradeSelect.value) || 6;
  const interest = interestInput.value.trim();
  state.profile = { name, grade, interest };
  state.allowance = 5000 + (grade - 6) * 200;
  state.balance = state.allowance;
  state.happiness = 75;
  state.knowledge = 0;
  state.badges = [];
  state.journal = [];
  state.portfolio = [];
  state.sips = [];
  state.fds = [];
  state.rank = 'Rookie';
  LEVELS.forEach(l => state.levelsProgress[l.key] = { stage:0, completed:false, unlocked: l.id===1 });
  saveState();
  addChat(`Welcome ${name}! Let's start Level 1.`, 'ai');
  updateProfileUI();
  startLevel(LEVELS[0].key);
}

function loadDemo(){
  state = defaultState();
  state.profile = { name:'Demo Student', grade:9, interest:'tech' };
  state.allowance = 5600; state.balance = 5600; state.happiness = 78; state.knowledge = 0; state.rank='Rookie';
  LEVELS.forEach(l => state.levelsProgress[l.key] = { stage:0, completed:false, unlocked: l.id===1 });
  saveState();
  updateProfileUI();
  addChat('Demo profile loaded. Starting Level 1.','ai');
  startLevel(LEVELS[0].key);
}

/* UI updates */
function updateProfileUI(){
  if(state.profile){
    profileCreateArea.classList.add('hidden');
    profileView.classList.remove('hidden');
    playerName.textContent = state.profile.name;
    playerGrade.textContent = 'Grade ' + state.profile.grade + (state.profile.interest ? ' • ' + state.profile.interest : '');
    playerRank.textContent = state.rank || 'Rookie';
    finBalance.textContent = '₹' + Math.round(state.balance);
    allowanceVal.textContent = '₹' + Math.round(state.allowance);
    happinessVal.textContent = Math.round(state.happiness);
    knowledgeVal.textContent = Math.round(state.knowledge);
    badgeCount.textContent = state.badges.length;
    badgesWrap.innerHTML = '';
    state.badges.forEach(b => { const s = document.createElement('span'); s.className='badge'; s.textContent = b; badgesWrap.appendChild(s); });
  } else {
    profileCreateArea.classList.remove('hidden');
    profileView.classList.add('hidden');
  }
}

/* Render levels hub */
function renderLevelsHub(){
  levelsHub.innerHTML = '';
  LEVELS.forEach(l => {
    const p = state.levelsProgress[l.key] || { stage:0, completed:false, unlocked: l.id===1 };
    const box = document.createElement('div'); box.className='level-box';
    const status = p.unlocked ? (p.completed ? 'Completed' : 'Unlocked') : 'Locked';
    box.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div><strong style="color:var(--lilac)">${l.id}. ${l.title}</strong><div class="small">${l.goal}</div></div>
      <div style="text-align:right">${status}<div class="small">${p.stage}/${l.stages} stages</div></div></div>`;
    const actions = document.createElement('div'); actions.style.marginTop='10px';
    const startBtn = document.createElement('button'); startBtn.className='btn'; startBtn.textContent = p.unlocked ? (p.completed ? 'Review' : 'Start') : 'Locked';
    startBtn.disabled = !p.unlocked; startBtn.addEventListener('click', ()=> startLevel(l.key));
    actions.appendChild(startBtn);
    const infoBtn = document.createElement('button'); infoBtn.className='btn secondary'; infoBtn.style.marginLeft='8px'; infoBtn.textContent='Info';
    infoBtn.addEventListener('click', ()=> { let info = `${l.title}\nGoal: ${l.goal}\nTopics:\n`; l.scenarios.forEach((s,i)=> info += ` - Stage ${i+1}: ${s.title}\n`); alert(info); });
    actions.appendChild(infoBtn);
    box.appendChild(actions);
    levelsHub.appendChild(box);
  });
}

/* Start a level */
function startLevel(key){
  if(!state.profile){ alert('Create profile first'); return; }
  const prog = state.levelsProgress[key];
  if(!prog || !prog.unlocked){ alert('Level locked'); return; }
  state.activeLevelKey = key; saveState();
  $('introArea').classList.add('hidden'); gameArea.classList.remove('hidden');
  renderCurrentStage();
  addChat(`Started ${LEVELS.find(l=>l.key===key).title}`,'ai');
}

/* Render stage */
function renderCurrentStage(){
  const key = state.activeLevelKey; if(!key) return;
  const lev = LEVELS.find(l => l.key === key); const prog = state.levelsProgress[key]; const idx = prog.stage || 0;
  levelTitle.textContent = `${lev.id}. ${lev.title}`; levelGoal.textContent = lev.goal;
  const pct = Math.round((idx / lev.stages) * 100); levelProgressBar.style.width = pct + '%';
  progressText.textContent = `${idx} / ${lev.stages} stages`;
  stageBox.innerHTML = ''; interactiveArea.innerHTML = ''; glossaryList.innerHTML = ''; glossaryBox.style.display = 'none';
  if(idx >= lev.stages){
    stageBox.innerHTML = `<div class="small">Level complete. Click Finish to finalize.</div><div style="margin-top:8px"><button class="btn" id="finishLevelBtn">Finish Level</button></div>`;
    $('finishLevelBtn')?.addEventListener('click', ()=> finishLevel(key));
    return;
  }
  const stage = lev.scenarios[idx];
  const titleDiv = document.createElement('div'); titleDiv.innerHTML = `<strong>${stage.title}</strong>`; stageBox.appendChild(titleDiv);

  // glossary for stage
  if(stage.glossary && Object.keys(stage.glossary).length > 0){
    glossaryBox.style.display = 'block';
    Object.keys(stage.glossary).forEach(term=> {
      const d = document.createElement('div'); d.className='term'; d.innerHTML = `<strong>${term}</strong> <span style="font-weight:600">(${stage.glossary[term]})</span>`; glossaryList.appendChild(d);
      if(!state.glossary.includes(term)) state.glossary.push(term);
    });
  }

  // handle types
  if(stage.type === 'choice'){
    stage.choices.forEach(choice => {
      const b = document.createElement('button'); b.className='choice'; b.textContent = choice.label;
      b.addEventListener('click', ()=> {
        // Spending/investing checks: do not allow wallet negative
        const willSpend = (choice.coins && choice.coins < 0) || choice.openFD || choice.invest || choice.investSIP;
        if(willSpend){
          // compute needed amount: abs(negative coins) + openFD + invest + investSIP fixed amounts
          let needed = 0;
          if(choice.coins && choice.coins < 0) needed += Math.abs(choice.coins);
          if(choice.openFD) needed += choice.openFD;
          if(choice.invest) needed += (choice.invest.amt || 0);
          if(choice.investSIP) needed += 500; // SIP initial payment
          if(state.balance < needed){ alert('Not enough FinCoins for this choice.'); return; }
          // confirm spending
          if(confirm('Are you sure you want to proceed with this choice?')) applyChoice(state.activeLevelKey, prog.stage, choice);
        } else {
          applyChoice(state.activeLevelKey, prog.stage, choice);
        }
      });
      interactiveArea.appendChild(b);
    });
  } else if(stage.type === 'drag'){
    const dz = document.createElement('div'); dz.style.display='flex'; dz.style.gap='12px';
    const itemsCol = document.createElement('div'); itemsCol.style.flex='0.45'; itemsCol.innerHTML = '<strong>Items</strong>';
    stage.items.forEach(it=>{
      const d = document.createElement('div'); d.className='choice'; d.draggable=true; d.id = it.id; d.style.cursor='grab'; d.textContent = it.text;
      d.addEventListener('dragstart', (ev)=> ev.dataTransfer.setData('text/plain', it.id));
      itemsCol.appendChild(d);
    });
    const needBox = document.createElement('div'); needBox.style.flex='0.27'; needBox.className='choice'; needBox.innerHTML='<strong>Needs</strong>'; needBox.addEventListener('dragover', ev=>ev.preventDefault()); needBox.addEventListener('drop', ev=>{ev.preventDefault(); const id = ev.dataTransfer.getData('text/plain'); const el = document.getElementById(id); if(el) needBox.appendChild(el);});
    const wantBox = document.createElement('div'); wantBox.style.flex='0.27'; wantBox.className='choice'; wantBox.innerHTML='<strong>Wants</strong>'; wantBox.addEventListener('dragover', ev=>ev.preventDefault()); wantBox.addEventListener('drop', ev=>{ev.preventDefault(); const id = ev.dataTransfer.getData('text/plain'); const el = document.getElementById(id); if(el) wantBox.appendChild(el);});
    dz.appendChild(itemsCol); dz.appendChild(needBox); dz.appendChild(wantBox); interactiveArea.appendChild(dz);
    const submit = document.createElement('div'); submit.style.marginTop='10px'; const sbtn = document.createElement('button'); sbtn.className='btn'; sbtn.textContent='Submit'; sbtn.addEventListener('click', ()=>{
      const correct = stage.items.every(it=>{
        const el = document.getElementById(it.id); if(!el || !el.parentElement) return false;
        const parent = el.parentElement;
        return (it.tag === 'Need' && parent === needBox) || (it.tag === 'Want' && parent === wantBox);
      });
      if(correct){
        state.knowledge += (stage.success?.knowledge || 1);
        const coins = stage.success?.coins || 0;
        if(coins) { state.balance += coins; coinFloat(coins); addJournal(`Drag success: gained ₹${coins}`); }
        addChat('Great! Needs vs Wants understood.','ai');
        advanceStage(state.activeLevelKey);
      } else {
        addChat('Some items misplaced. Try thinking what is required vs optional.','ai');
      }
      saveState(); updateProfileUI(); renderJournal();
    }); submit.appendChild(sbtn); interactiveArea.appendChild(submit);
  } else if(stage.type === 'input'){
    const wrap = document.createElement('div'); wrap.style.marginTop='8px';
    const inp = document.createElement('input'); inp.placeholder = 'Enter amount or answer';
    wrap.appendChild(inp);
    const sbtn = document.createElement('button'); sbtn.className='btn'; sbtn.textContent='Submit'; sbtn.style.marginLeft='8px';
    sbtn.addEventListener('click', ()=> {
      const val = inp.value.trim(); if(!val){ addChat('Enter a value','ai'); return; }
      if(stage.action === 'keepGoal'){
        addJournal(`Kept ₹${val} for short-term goal (remains in wallet)`); addChat('Good — keeping money in wallet for goal (no separate savings).','ai'); advanceStage(state.activeLevelKey);
      } else if(stage.action === 'allocate'){
        const parts = val.replace(/,/g,'/').split('/');
        const a = parseInt(parts[0]) || 0, b = parseInt(parts[1]) || 0;
        if(a + b !== 100){ addChat('Enter percentages that sum to 100 (e.g., 70/30).','ai'); return; }
        state.knowledge += 2; addJournal(`Allocated ${a}% safe / ${b}% risky`); addChat('Good allocation — balance reduces risk.','ai'); advanceStage(state.activeLevelKey);
      } else if(stage.action === 'buildPortfolio'){
        state.knowledge += 3; addJournal(`Built portfolio: ${val}`); addChat('Portfolio created. Diversification noted.','ai'); advanceStage(state.activeLevelKey);
      } else {
        addJournal(`Input: ${val}`); advanceStage(state.activeLevelKey);
      }
      saveState(); updateProfileUI(); renderJournal();
    });
    wrap.appendChild(sbtn); interactiveArea.appendChild(wrap);
  } else if(stage.type === 'action'){
    const sbtn = document.createElement('button'); sbtn.className='btn'; sbtn.textContent='Run';
    sbtn.addEventListener('click', ()=> {
      if(stage.action === 'calcROI'){
        const pcalc = calcPortfolio();
        const invested = pcalc.cost;
        const simulatedGain = Math.round((Math.random()*0.25 - 0.05) * Math.max(1, invested));
        addChat(`Sample ROI simulation: ${simulatedGain >= 0 ? '+' : ''}${simulatedGain} on ₹${invested}`, 'ai');
        addJournal(`Calculated ROI: ${simulatedGain}`);
      }
      advanceStage(state.activeLevelKey);
      saveState();
    });
    interactiveArea.appendChild(sbtn);
  }
}

/* Apply choice */
function applyChoice(levelKey, stageIndex, choice){
  // Prevent negative wallet: check already done before calling
  if(choice.coins){
    state.balance += choice.coins; // coins negative -> deduction
    coinFloat(choice.coins);
  }
  if(choice.openFD){
    const amt = Number(choice.openFD) || 0;
    state.balance -= amt; // verified earlier
    state.fds = state.fds || []; state.fds.push({ amt, start: now(), months:3, matured:false });
    addJournal(`Opened FD: ₹${amt}`);
    addChat('FD opened — will mature later (demo simulation).','ai');
  }
  if(choice.investSIP){
    state.sips = state.sips || []; state.sips.push({ kind: choice.investSIP, amt:500, weeks:0 });
    state.balance -= 500; addJournal(`Started SIP ${choice.investSIP} (₹500)`); coinFloat(-500);
  }
  if(choice.invest){
    // invest. The invest amount already deducted via coins in the choice object (we did state.balance += coins)
    // But some choices include both coins:-1000 and invest: { amt:1000 } — coins deduction handled above. Record portfolio entry
    const investAmt = choice.invest.amt || Math.abs(choice.coins || 0);
    const asset = choice.invest.asset || (choice.invest.type || 'misc');
    const price = (state.market[asset] || [1]).slice(-1)[0] || 1;
    const lots = investAmt / price;
    state.portfolio.push({ asset, amt: investAmt, priceBought: price, lots, time: now() });
    addJournal(`Invested ₹${investAmt} in ${asset}`);
  }
  if(choice.know) state.knowledge += choice.know;
  if(choice.happy) state.happiness = Math.max(0, Math.min(100, state.happiness + (choice.happy||0)));
  if(choice.note) addJournal(choice.note);
  // terms
  if(choice.terms){ choice.terms.forEach(t => { if(!state.glossary.includes(t)) state.glossary.push(t); }); }
  // feedback
  let feedback = 'Good choice!';
  if(choice.rating !== undefined){
    if(choice.rating >= 2) feedback = 'Smart move — good long-term thinking.';
    else if(choice.rating === 1) feedback = 'Balanced choice.';
    else feedback = 'This may hurt savings in the long-term — be careful.';
  }
  addChat(feedback, 'ai');
  saveState(); renderJournal(); updateProfileUI();
  advanceStage(levelKey);
}

/* Advance stage logic */
function advanceStage(key){
  const prog = state.levelsProgress[key];
  prog.stage = (prog.stage || 0) + 1;
  const lev = LEVELS.find(l => l.key === key);
  if(prog.stage >= lev.stages){
    prog.completed = true;
    const badge = `${lev.title.split(' ')[0]} Badge`;
    if(!state.badges.includes(badge)) state.badges.push(badge);
    const next = LEVELS.find(x=>x.id === lev.id + 1);
    if(next) state.levelsProgress[next.key].unlocked = true;
    addChat(`Level ${lev.id} completed. Badge: ${badge}`, 'ai'); addJournal(`Completed Level ${lev.id}: ${lev.title}`);
  } else {
    addChat('Stage complete — continue!', 'ai');
  }
  saveState(); renderLevelsHub(); renderCurrentStage(); updateProfileUI();
}

/* Finish level */
function finishLevel(key){
  state.levelsProgress[key].completed = true;
  const lev = LEVELS.find(l => l.key === key);
  const badge = `${lev.title.split(' ')[0]} Badge`;
  if(!state.badges.includes(badge)) state.badges.push(badge);
  const next = LEVELS.find(x=>x.id === lev.id + 1);
  if(next) state.levelsProgress[next.key].unlocked = true;
  addJournal(`Finished Level ${lev.id}`); saveState(); renderLevelsHub(); updateProfileUI();
}

/* Journal */
function addJournal(text){ state.journal.push({ time: now(), text }); if(state.journal.length > 400) state.journal.shift(); saveState(); renderJournal(); }
function renderJournal(){ journalList.innerHTML = ''; state.journal.slice().reverse().forEach(j => { const d = document.createElement('div'); d.className='small'; d.style.marginBottom='6px'; d.textContent = `${new Date(j.time).toLocaleString()}: ${j.text}`; journalList.appendChild(d); }); }

/* Glossary render */
function renderGlossary(){ glossaryList.innerHTML = ''; if(state.glossary && state.glossary.length){ glossaryBox.style.display = 'block'; state.glossary.forEach(term=>{ let def='(definition)'; LEVELS.forEach(l=> { l.scenarios.forEach(s=> { if(s.glossary && s.glossary[term]) def = s.glossary[term]; }); }); const d = document.createElement('div'); d.className='term'; d.innerHTML = `<strong>${term}</strong> <span style="font-weight:600">(${def})</span>`; glossaryList.appendChild(d); }); } else glossaryBox.style.display='none'; }

/* Market & chart */
function generateMarket(){
  function series(base, varr=8){ let v = base; const arr=[]; for(let i=0;i<30;i++){ v += (Math.random()-0.5)*varr; v = Math.max(1, v); arr.push(Math.round(v*100)/100); } return arr; }
  return { gold: series(320,6), silver: series(25,2.5), tech: series(100,14) };
}
function redrawChart(){
  const c = chart; const dpr = devicePixelRatio || 1; c.width = c.clientWidth * dpr; c.height = c.clientHeight * dpr; const ctx = c.getContext('2d'); ctx.scale(dpr,dpr); ctx.clearRect(0,0,c.clientWidth,c.clientHeight);
  ctx.fillStyle = '#f6f9ff'; ctx.fillRect(0,0,c.clientWidth,c.clientHeight);
  const assets = Object.keys(state.market);
  const colors = { gold:'#ffd86b', silver:'#c0c0c0', tech:'#88aaff' };
  assets.forEach((a,ai)=>{ const series = state.market[a]; const minv = Math.min(...series), maxv = Math.max(...series); ctx.beginPath(); series.forEach((v,i)=>{ const x = 10 + i*(c.clientWidth-20)/(series.length-1); const y = 20 + (1 - (v - minv)/(maxv - minv || 1))*(c.clientHeight - 40); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.strokeStyle = colors[a] || '#777'; ctx.lineWidth = 2; ctx.stroke(); ctx.fillStyle='rgba(0,0,0,0.02)'; ctx.fillText(a, 12, 12 + ai*12); });
  const p = calcPortfolio(); portfolioVal.textContent = '₹' + p.value; pnlVal.textContent = '₹' + (p.value - p.cost);
}
function calcPortfolio(){ let val=0, cost=0; state.portfolio.forEach(p=>{ const cur = (state.market[p.asset] || []).slice(-1)[0] || p.priceBought || 1; const lots = p.lots || (p.amt / (p.priceBought || 1)); val += Math.round(lots * cur); cost += p.amt || 0; }); return { value: val, cost }; }

/* Investment: deduct once on buy, realize P/L on sell */
function performInvestment(){
  if(!state.profile){ alert('Create profile first'); return; }
  if(document.getElementById('parentMode') && document.getElementById('parentMode').checked){ addChat('Parent mode active — actions disabled.','ai'); return; }
  const asset = assetSelect.value; const amt = Math.round(Number(investAmount.value) || 0);
  if(amt <= 0){ addChat('Enter valid amount to invest','ai'); return; }
  if(state.balance < amt){ addChat('Not enough FinCoins','ai'); return; }
  // Deduct once here
  if(!confirm(`Invest ₹${amt} in ${asset}?`)) return;
  state.balance -= amt; coinFloat(-amt);
  // record purchase at current market price
  const priceSeries = state.market[asset]; const price = priceSeries[priceSeries.length-1];
  const lots = amt / price;
  state.portfolio.push({ asset, amt, priceBought: price, lots, time: now() });
  state.journal.push({ time: now(), text:`Invested ₹${amt} in ${asset} at ${price}` });
  addChat(`Invested ₹${amt} in ${asset}. Sell later to realize profit/loss.`, 'ai');
  saveState(); redrawChart(); updateProfileUI(); renderJournal(); renderPortfolioList();
}

/* Render portfolio list with sell actions */
function renderPortfolioList(){
  portfolioList.innerHTML = '';
  if(state.portfolio.length === 0){ portfolioList.innerHTML = '<div class="small">No holdings yet.</div>'; return; }
  state.portfolio.forEach((p, idx) => {
    const cur = (state.market[p.asset] || []).slice(-1)[0] || p.priceBought;
    const value = Math.round((p.lots || (p.amt/p.priceBought)) * cur);
    const pnl = value - (p.amt || 0);
    const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.justifyContent='space-between'; wrap.style.alignItems='center'; wrap.style.marginBottom='8px';
    wrap.innerHTML = `<div><strong>${p.asset}</strong><div class="small">Bought: ₹${p.amt} @ ${p.priceBought}</div><div class="small">Current: ₹${value} (P/L: ₹${pnl})</div></div>`;
    const sellBtn = document.createElement('button'); sellBtn.className='btn secondary'; sellBtn.textContent='Sell';
    sellBtn.addEventListener('click', ()=> {
      if(!confirm(`Sell holding (${p.asset}) for current value ₹${value}?`)) return;
      // realize profit/loss into wallet
      state.balance += value;
      coinFloat(value);
      addJournal(`Sold ${p.asset} for ₹${value} (P/L: ₹${pnl})`);
      state.portfolio.splice(idx,1);
      saveState(); updateProfileUI(); redrawChart(); renderPortfolioList(); renderJournal();
      addChat(`Sold ${p.asset}. ₹${value} added to wallet.`, 'ai');
    });
    wrap.appendChild(sellBtn);
    portfolioList.appendChild(wrap);
  });
}

/* SIP and FD processing (demo) - called manually (e.g., triggered by market sim or daily advance if you add) */
function processSIPsAndFDs(){
  // SIP: attempt to debit weekly SIP contributions if wallet has funds; small simulated growth added directly to wallet
  if(state.sips && state.sips.length){
    state.sips.forEach(s => {
      if(state.balance >= s.amt){
        state.balance -= s.amt;
        // simulated immediate micro-return
        const pct = s.kind === 'safe' ? 0.01 : s.kind === 'balanced' ? 0.02 : 0.04;
        const gain = Math.round(s.amt * (Math.random() * pct));
        state.balance += gain;
        state.journal.push({ time: now(), text: `SIP ${s.kind}: invested ₹${s.amt}, micro-return ₹${gain}` });
      }
    });
  }
  // FD maturity demo (fast-forward): matured if older than demo threshold
  if(state.fds && state.fds.length){
    state.fds.forEach((fd, i) => {
      if(!fd.matured && (Date.now() - (fd.start || Date.now())) > 1000 * 60 * 60 * 24 * 3){ // 3 days demo
        const interest = Math.round(fd.amt * 0.06);
        const out = fd.amt + interest;
        state.balance += out;
        fd.matured = true;
        addJournal(`FD matured: ₹${fd.amt} + interest ₹${interest} added to wallet`);
        coinFloat(out);
      }
    });
  }
  saveState(); updateProfileUI(); renderJournal();
}

/* Quiz runner */
function runQuiz(title, qlist, onComplete){
  stageBox.innerHTML = `<div><strong>${title}</strong></div><div id="quizBox" style="margin-top:8px"></div>`;
  const qbox = $('quizBox'); let i=0, score=0;
  function showQ(){
    if(i >= qlist.length){ qbox.innerHTML = `<div class="small">Quiz complete: ${score}/${qlist.length}</div>`; if(onComplete) onComplete(score); return; }
    const q = qlist[i];
    qbox.innerHTML = `<div style="font-weight:700">${i+1}. ${q.q}</div>`;
    q.opts.forEach((o, idx)=>{ const opt = document.createElement('button'); opt.className='choice'; opt.textContent = o; opt.addEventListener('click', ()=> { if(idx === q.ans){ score++; addChat('Correct!','ai'); } else addChat('Not quite.','ai'); i++; showQ(); }); qbox.appendChild(opt); });
  }
  showQ();
}

/* Saturday quiz */
function takeSaturdayQuiz(){
  const completed = LEVELS.filter(l=> state.levelsProgress[l.key] && state.levelsProgress[l.key].completed);
  if(completed.length === 0){ alert('Complete at least one level to take the Saturday quiz'); return; }
  const qs = [
    { q:'Which is typically a NEED?', opts:['Concert ticket','Groceries','New gaming console'], ans:1 },
    { q:'Interest is:', opts:['Money banks pay for saving','A loan fee','A shopping discount'], ans:0 },
    { q:'SIP stands for:', opts:['Single Invest Plan','Systematic Investment Plan','Savings Invest Product'], ans:1 },
    { q:'Diversification helps to:', opts:['Increase risk','Reduce risk','Make instant profit'], ans:1 },
    { q:'FD lock period means:', opts:['You can withdraw anytime','You lock money for a time to earn more','It is a spending card'], ans:1 }
  ];
  runQuiz('Saturday Quiz', qs, (score)=> {
    const bonus = 50 * score;
    state.balance += bonus; state.knowledge += Math.round(score/1.5);
    addJournal(`Saturday Quiz: ${score}/${qs.length} — bonus ₹${bonus}`); saveState(); updateProfileUI(); renderJournal();
    addChat(`Quiz finished: ${score}/${qs.length}. Bonus ₹${bonus}`, 'ai');
  });
}

/* Easter quiz */
function showEasterQuiz(){
  const q = { q:'Easter: Which saves more in long term?', opts:['Spending on wants','Regular small investments','Random chance'], ans:1 };
  runQuiz('Easter Bonus Quiz', [q], (score) => {
    if(score > 0){
      const bonus = 100 + Math.round(Math.random()*400);
      state.balance += bonus; state.knowledge += 2; addJournal(`Easter bonus ₹${bonus}`); showBonusPop(bonus); saveState(); updateProfileUI(); renderJournal();
      addChat(`Easter success! Bonus ₹${bonus}`, 'ai');
    } else addChat('No bonus this time.','ai');
  });
}
function showBonusPop(amount){
  const popup = document.createElement('div'); popup.style.position='fixed'; popup.style.left='50%'; popup.style.top='40%'; popup.style.transform='translate(-50%,-50%) scale(.7)'; popup.style.padding='16px 22px'; popup.style.borderRadius='12px'; popup.style.background='linear-gradient(135deg,#8EA207,#4569AD)'; popup.style.color='white'; popup.style.fontWeight='800'; popup.style.zIndex=9999; popup.innerHTML = `🎉 Bonus FinCoins × <span style="font-size:1.5rem">${amount}</span>`; document.body.appendChild(popup);
  setTimeout(()=>{ popup.style.transform='translate(-50%,-50%) scale(1)'; popup.style.opacity=1; }, 60);
  setTimeout(()=>{ popup.style.transform='translate(-50%,-50%) scale(.8)'; popup.style.opacity=0; }, 2600);
  setTimeout(()=> popup.remove(),3200);
}

/* Chat handler */
function handleChat(text){
  const q = text.toLowerCase();
  if(q.includes('save') || q.includes('budget')) addChat('Tip: Save regularly and set a clear goal. This prototype keeps saved money in your wallet.', 'ai');
  else if(q.includes('invest')) addChat('Tip: Diversify and prefer SIPs for long-term discipline.', 'ai');
  else addChat('Try asking: "Should I buy this gadget for ₹1500?"', 'ai');
}

/* Modal helpers */
function showModal(title, desc, cb){ modalTitle.textContent = title; modalDesc.innerHTML = desc; modalBackdrop.classList.add('show'); modalConfirm._cb = cb; }
function closeModal(){ modalBackdrop.classList.remove('show'); modalConfirm._cb = null; }

/* Portfolio utilities */
function calcPortfolio(){ let val=0, cost=0; state.portfolio.forEach(p=>{ const cur = (state.market[p.asset] || []).slice(-1)[0] || p.priceBought || 1; const lots = p.lots || (p.amt / (p.priceBought || 1)); val += Math.round(lots * cur); cost += p.amt || 0; }); return { value: val, cost }; }
function renderPortfolioList(){ portfolioList.innerHTML = ''; if(state.portfolio.length === 0){ portfolioList.innerHTML = '<div class="small">No holdings yet.</div>'; return; } state.portfolio.forEach((p, idx) => { const cur = (state.market[p.asset] || []).slice(-1)[0] || p.priceBought; const value = Math.round((p.lots || (p.amt/p.priceBought)) * cur); const pnl = value - (p.amt || 0); const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.justifyContent='space-between'; wrap.style.alignItems='center'; wrap.style.marginBottom='8px'; wrap.innerHTML = `<div><strong>${p.asset}</strong><div class="small">Bought: ₹${p.amt} @ ${p.priceBought}</div><div class="small">Current: ₹${value} (P/L: ₹${pnl})</div></div>`; const sellBtn = document.createElement('button'); sellBtn.className='btn secondary'; sellBtn.textContent='Sell'; sellBtn.addEventListener('click', ()=> { if(!confirm(`Sell holding (${p.asset}) for current value ₹${value}?`)) return; state.balance += value; coinFloat(value); addJournal(`Sold ${p.asset} for ₹${value} (P/L: ₹${pnl})`); state.portfolio.splice(idx,1); saveState(); updateProfileUI(); redrawChart(); renderPortfolioList(); renderJournal(); addChat(`Sold ${p.asset}. ₹${value} added to wallet.`, 'ai'); }); wrap.appendChild(sellBtn); portfolioList.appendChild(wrap); }); }

/* Helpers for saving/loading */
saveState(); // ensure stored

/* initial visuals */
updateProfileUI(); renderLevelsHub(); redrawChart(); renderJournal(); renderGlossary();

/* Expose state for debugging */
window._finquest_state = state;

/* Exposed small helper to trigger SIP/FD processing (if demo wants) */
window._processSIPsAndFDs = processSIPsAndFDs;

</script>
</body>
</html>
